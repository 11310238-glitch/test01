# é€™æ˜¯ Google Colab å°ˆæ¡ˆï¼Œéœ€è¦å®‰è£ Gradio å’Œ Pandas å…©å€‹åº«
!pip install gradio pandas

import gradio as gr
import pandas as pd
import os
import uuid # ç”¨æ–¼ç”Ÿæˆå”¯ä¸€çš„ç‰©å“ ID

# --- P1: ç³»çµ±è³‡æ–™ç®¡ç†æ¨¡çµ„ (Storage & Data Persistence) ---
FILE_PATH = 'exchange_items.csv'

# å®šç¾©åŸºç¤è³‡æ–™çµæ§‹çš„æ¬„ä½
COLUMNS = ['ID', 'åç¨±', 'é¡åˆ¥', 'æè¿°', 'ç‹€æ…‹', 'è¯çµ¡è³‡è¨Š', 'åˆŠç™»æ—¥æœŸ']

def load_items():
    """å¾ CSV æª”æ¡ˆè¼‰å…¥ç‰©å“æ¸…å–®ï¼Œå¦‚æœæª”æ¡ˆä¸å­˜åœ¨å‰‡å‰µå»ºæ–°çš„ DataFrame"""
    if os.path.exists(FILE_PATH):
        try:
            # å˜—è©¦è®€å– CSV
            df = pd.read_csv(FILE_PATH)
            # ç¢ºä¿ ID æ˜¯å­—ä¸²ï¼Œä»¥é˜²è®€å–æ™‚è‡ªå‹•è½‰å‹
            df['ID'] = df['ID'].astype(str)
        except pd.errors.EmptyDataError:
            # æª”æ¡ˆå­˜åœ¨ä½†ç‚ºç©ºæ™‚ï¼Œå‰µå»ºç©º DataFrame
            df = pd.DataFrame(columns=COLUMNS)
    else:
        # æª”æ¡ˆä¸å­˜åœ¨æ™‚ï¼Œå‰µå»ºç©º DataFrame
        df = pd.DataFrame(columns=COLUMNS)
    return df

def save_items(df):
    """å°‡ç‰©å“æ¸…å–®å­˜å› CSV æª”æ¡ˆ"""
    df.to_csv(FILE_PATH, index=False)

# åœ¨ç¨‹å¼å•Ÿå‹•æ™‚è¼‰å…¥ä¸€æ¬¡è³‡æ–™
items_df = load_items()


# --- P2: åˆŠç™»èˆ‡åˆªé™¤ä»‹é¢ (Posting & Deleting) ---

def add_item_to_list(name, category, description, contact):
    """æ–°å¢ç‰©å“åŠŸèƒ½ (å°æ‡‰æ•…äº‹ 1)"""
    global items_df
    if not all([name, category, description, contact]):
        return "âŒ éŒ¯èª¤ï¼šæ‰€æœ‰æ¬„ä½éƒ½å¿…é ˆå¡«å¯«ï¼", items_df

    # ç”Ÿæˆå”¯ä¸€çš„ ID
    new_id = str(uuid.uuid4())[:8]

    # å»ºç«‹æ–°ç‰©å“çš„è³‡æ–™åˆ—
    new_item = pd.DataFrame([{
        'ID': new_id,
        'åç¨±': name,
        'é¡åˆ¥': category,
        'æè¿°': description,
        'ç‹€æ…‹': 'å¾…äº¤æ›', # é è¨­ç‹€æ…‹
        'è¯çµ¡è³‡è¨Š': contact,
        'åˆŠç™»æ—¥æœŸ': pd.Timestamp.now().strftime('%Y-%m-%d %H:%M')
    }])

    # åŠ å…¥åˆ°ä¸» DataFrame
    items_df = pd.concat([items_df, new_item], ignore_index=True)
    save_items(items_df) # å„²å­˜è³‡æ–™ (å°æ‡‰æ•…äº‹ 7)
    return f"âœ… æˆåŠŸåˆŠç™»ï¼ç‰©å“ID: {new_id}ã€‚è¨˜å¾—åˆ†äº«çµ¦éœ€è¦çš„åŒå­¸ï¼", items_df

def delete_item_by_id(item_id):
    """åˆªé™¤ç‰©å“åŠŸèƒ½ (å°æ‡‰æ•…äº‹ 6)"""
    global items_df
    if not item_id:
        return "âŒ éŒ¯èª¤ï¼šè«‹è¼¸å…¥æœ‰æ•ˆçš„ç‰©å“ IDã€‚", items_df

    initial_count = len(items_df)
    # åˆªé™¤åŒ¹é… ID çš„è¡Œ
    items_df = items_df[items_df['ID'] != item_id]

    if len(items_df) < initial_count:
        save_items(items_df)
        return f"âœ… æˆåŠŸåˆªé™¤ ID ç‚º {item_id} çš„ç‰©å“ã€‚", items_df
    else:
        return f"âŒ åˆªé™¤å¤±æ•—ï¼šæ‰¾ä¸åˆ° ID ç‚º {item_id} çš„ç‰©å“ã€‚", items_df


# --- P3: æ¸…å–®é¡¯ç¤º (Display) (åœ¨ Gradio ä¸­ç”± Dataframe çµ„ä»¶è‡ªå‹•å¯¦ç¾) ---
# --- P4: æœå°‹èˆ‡ç¯©é¸é‚è¼¯ (Search & Filter) ---

def search_and_filter(keyword, category_filter):
    """æ ¹æ“šé—œéµå­—å’Œé¡åˆ¥é€²è¡Œæœå°‹ (å°æ‡‰æ•…äº‹ 3)"""
    df = items_df.copy() # è¤‡è£½ä¸€ä»½ï¼Œé¿å…ä¿®æ”¹åŸå§‹è³‡æ–™
    message = "âœ… é€™æ˜¯ç›®å‰çš„äº¤æ›æ¸…å–®ï¼š"

    # 1. é¡åˆ¥ç¯©é¸
    if category_filter and category_filter != "æ‰€æœ‰é¡åˆ¥":
        df = df[df['é¡åˆ¥'] == category_filter]
        message = f"âœ… é€™æ˜¯ '{category_filter}' é¡åˆ¥çš„ç‰©å“æ¸…å–®ï¼š"

    # 2. é—œéµå­—æœå°‹
    if keyword:
        # æœå°‹ åç¨± æˆ– æè¿° æ¬„ä½
        df = df[df['åç¨±'].str.contains(keyword, case=False, na=False) |
                df['æè¿°'].str.contains(keyword, case=False, na=False)]
        message = f"âœ… é€™æ˜¯æœå°‹é—œéµå­— '{keyword}' çš„çµæœæ¸…å–®ï¼š"

    if df.empty:
        message = "âŒ æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„ç‰©å“ã€‚"

    return message, df


# --- P5: ç‹€æ…‹æ›´æ–°èˆ‡ä¸»é¸å–® (Controller) ---

def update_item_status(item_id, new_status):
    """æ›´æ–°ç‰©å“ç‹€æ…‹åŠŸèƒ½ (å°æ‡‰æ•…äº‹ 5)"""
    global items_df
    if not item_id or not new_status:
        return "âŒ éŒ¯èª¤ï¼šè«‹è¼¸å…¥ ID ä¸¦é¸æ“‡æ–°ç‹€æ…‹ã€‚", items_df

    # æª¢æŸ¥ ID æ˜¯å¦å­˜åœ¨
    if item_id in items_df['ID'].values:
        # ä½¿ç”¨ .loc é€²è¡Œç²¾æº–ä¿®æ”¹
        items_df.loc[items_df['ID'] == item_id, 'ç‹€æ…‹'] = new_status
        save_items(items_df)
        return f"âœ… æˆåŠŸå°‡ ID {item_id} çš„ç‹€æ…‹æ›´æ–°ç‚º '{new_status}'ã€‚", items_df
    else:
        return f"âŒ ç‹€æ…‹æ›´æ–°å¤±æ•—ï¼šæ‰¾ä¸åˆ° ID ç‚º {item_id} çš„ç‰©å“ã€‚", items_df


# -----------------------------------------------------
# --- Gradio ä»‹é¢è¨­å®š (å¯¦ç¾æ•…äº‹ 8) ---
# -----------------------------------------------------

# å–å¾—ç›®å‰æ‰€æœ‰çš„é¡åˆ¥ä¾›ä¸‹æ‹‰é¸å–®ä½¿ç”¨
def get_categories():
    categories = items_df['é¡åˆ¥'].unique().tolist()
    return ["æ‰€æœ‰é¡åˆ¥"] + categories if categories else ["æ‰€æœ‰é¡åˆ¥", "èª²æœ¬", "ç”Ÿæ´»ç”¨å“", "é›»å­ç”¢å“", "å…¶ä»–"]

with gr.Blocks(title="æ ¡åœ’äºŒæ‰‹ç‰©è³‡äº¤æ›å¹³è‡ºåŠ©æ‰‹") as demo:
    gr.Markdown("# ğŸ“š æ ¡åœ’äºŒæ‰‹ç‰©è³‡äº¤æ›å¹³è‡ºåŠ©æ‰‹")
    gr.Markdown("æ­¡è¿ä½¿ç”¨æ ¡åœ’äº¤æ›åŠ©æ‰‹ï¼è«‹åœ¨ä¸‹æ–¹æ¨™ç±¤é åˆ‡æ›åŠŸèƒ½ã€‚")

    status_message = gr.Textbox(label="ç³»çµ±è¨Šæ¯", interactive=False, value="ç³»çµ±å•Ÿå‹•æˆåŠŸï¼", visible=True)

    # ä½¿ç”¨ Dataframe çµ„ä»¶é¡¯ç¤ºæ¸…å–® (å°æ‡‰æ•…äº‹ 2, 4)
    item_display = gr.Dataframe(
        value=items_df,
        headers=COLUMNS,
        label="ç‰©å“äº¤æ›æ¸…å–®",
        interactive=False, # ä¸å…è¨±ä½¿ç”¨è€…ç›´æ¥ä¿®æ”¹è¡¨æ ¼
        row_count=(1, "dynamic"),
        col_count=len(COLUMNS) # ä¿®æ”¹é€™è£¡ï¼šå°‡ "dynamic" æ”¹ç‚º len(COLUMNS) ä»¥åŒ¹é… headers æ•¸é‡
    )

    with gr.Tab("ç‰©å“åˆŠç™» ğŸš€"):
        gr.Markdown("### åˆŠç™»æ–°ç‰©å“ (æ•…äº‹ 1)")
        name_in = gr.Textbox(label="ç‰©å“åç¨±", placeholder="ä¾‹å¦‚ï¼šå¾®ç©åˆ†èª²æœ¬ (ä¸Š)")
        category_in = gr.Dropdown(get_categories(), label="é¡åˆ¥", value="èª²æœ¬")
        desc_in = gr.Textbox(label="ç°¡çŸ­æè¿°", placeholder="ä¾‹å¦‚ï¼šä¹æˆæ–°ï¼Œæ›¸çš®æœ‰è¼•å¾®æ‘ºç—•")
        contact_in = gr.Textbox(label="è¯çµ¡è³‡è¨Š (Email/åˆ†æ©Ÿ/Line ID)", placeholder="ä¾‹å¦‚ï¼šjohnny@stu.ntu.edu.tw")
        add_btn = gr.Button("åˆŠç™»ç‰©å“")

    with gr.Tab("æœå°‹èˆ‡ç¯©é¸ ğŸ”"):
        gr.Markdown("### æœå°‹äº¤æ›ç‰©å“ (æ•…äº‹ 3)")
        keyword_search = gr.Textbox(label="é—œéµå­—æœå°‹", placeholder="è¼¸å…¥ç‰©å“åç¨±æˆ–æè¿°ä¸­çš„å­—è©")
        category_filter_dd = gr.Dropdown(get_categories(), label="ä¾é¡åˆ¥ç¯©é¸", value="æ‰€æœ‰é¡åˆ¥")
        search_btn = gr.Button("é–‹å§‹æœå°‹/é¡¯ç¤ºæ‰€æœ‰")

    with gr.Tab("ç‹€æ…‹ç®¡ç† (åˆŠç™»è€…) ğŸ”§"):
        gr.Markdown("### ç‰©å“ç‹€æ…‹è®Šæ›´èˆ‡åˆªé™¤ (æ•…äº‹ 5, 6)")
        status_id_in = gr.Textbox(label="ç‰©å“ ID", placeholder="è¼¸å…¥è¦è®Šæ›´ç‹€æ…‹çš„ç‰©å“ ID")
        status_dd = gr.Dropdown(['å¾…äº¤æ›', 'é è¨‚', 'å·²æˆäº¤'], label="é¸æ“‡æ–°ç‹€æ…‹", value='å¾…äº¤æ›')
        update_btn = gr.Button("æ›´æ–°ç‰©å“ç‹€æ…‹")

        gr.Markdown("---")
        delete_id_in = gr.Textbox(label="ç‰©å“ ID", placeholder="è¼¸å…¥è¦åˆªé™¤çš„ç‰©å“ ID")
        delete_btn = gr.Button("åˆªé™¤ç‰©å“")


    # --- äº‹ä»¶è™•ç† (å°‡æŒ‰éˆ•èˆ‡å‡½å¼ç¶å®š) ---

    # åˆŠç™»
    add_btn.click(
        add_item_to_list,
        inputs=[name_in, category_in, desc_in, contact_in],
        outputs=[status_message, item_display]
    )

    # æœå°‹/ç¯©é¸
    search_btn.click(
        search_and_filter,
        inputs=[keyword_search, category_filter_dd],
        outputs=[status_message, item_display]
    )

    # ç‹€æ…‹æ›´æ–°
    update_btn.click(
        update_item_status,
        inputs=[status_id_in, status_dd],
        outputs=[status_message, item_display]
    )

    # åˆªé™¤
    delete_btn.click(
        delete_item_by_id,
        inputs=[delete_id_in],
        outputs=[status_message, item_display]
    )

# å•Ÿå‹• Gradio ä»‹é¢ï¼Œä½¿ç”¨ share=True ç¢ºä¿åœ¨ Colab ä¸Šå¯ç”¨
demo.launch(share=True)
